-- Many Function Version Warlock 9.0.5/6
if not IROVar then IROVar={}end;if not IROVar.Lock then IROVar.Lock={}end;IROVar.Lock.PetActive=nil;IROVar.Lock.playerGUID=UnitGUID("player")IROVar.Lock.SS={}IROVar.Lock.SS.LockSpellModSS={["Hand of Gul'dan266"]=-30,["Shadow Bolt266"]=10,["Call Dreadstalkers266"]=-20,["Summon Vilefiend266"]=-10,["Nether Portal266"]=-10,["Summon Demonic Tyrant266"]=50,["Demonbolt266"]=20,["Seed of Corruption265"]=-10,["Malefic Rapture265"]=-10,["Chaos Bolt267"]=-20,["Incinerate267"]=2}IROVar.Lock.Imp={}IROVar.Lock.Imp.FreezEn=false;IROVar.Lock.Imp.count=0;IROVar.Lock.Imp.spawn={}IROVar.Lock.PetCheckedTime=0;IROVar.Lock.PetCheckTimer=6;IROVar.Lock.PetActiveOldVal=-1;IROVar.Lock.JustRunPetCheck=0;function IROVar.Lock.Pet(a)a=a or 0;if IROVar.Lock.PetActive then if IROVar.Lock.PetActive~=128 then return bit.band(IROVar.Lock.PetActive,a)~=0 else return UnitExists("pet")and not UnitIsDead("pet")end end;IROVar.Lock.SetupPetEvent()return IROVar.Lock.Pet(a)end;IROVar.Lock.PetTypeBit={["Felguard"]=1,["Succubus"]=2,["Felhunter"]=4,["Voidwalker"]=8,["Imp"]=16,["Wrathguard"]=1,["Shivarra"]=2,["Observer"]=4,["Voidlord"]=8,["Fel Imp"]=16}function IROVar.Lock.SetupPetEvent()function IROVar.Lock.CheckPet()local b=GetTime()if b-IROVar.Lock.JustRunPetCheck<0.05 then return end;IROVar.Lock.JustRunPetCheck=b;if b<IROVar.Lock.PetCheckedTime+IROVar.Lock.PetCheckTimer then IROVar.Lock.PetActive=0;if UnitExists("pet")and not UnitIsDead("pet")then local c=UnitCreatureFamily("pet")IROVar.Lock.PetActive=IROVar.Lock.PetTypeBit[c]or 0 else IROVar.Lock.PetActive=128 end;if IROVar.Lock.PetActive~=IROVar.Lock.PetActiveOldVal then IROVar.Lock.PetCheckedTime=b;IROVar.Lock.PetActiveOldVal=IROVar.Lock.PetActive end;C_Timer.After(0.2,IROVar.Lock.CheckPet)end end;IROVar.Lock.PetEvent=CreateFrame("Frame")IROVar.Lock.PetEvent:RegisterEvent("UNIT_PET")IROVar.Lock.PetEvent:SetScript("OnEvent",function()IROVar.Lock.PetCheckedTime=GetTime()IROVar.Lock.CheckPet()end)IROVar.Lock.PetCheckedTime=GetTime()IROVar.Lock.CheckPet()end;function IROVar.Lock.CheckImpExpire()local b=GetTime()for d,e in pairs(IROVar.Lock.Imp.spawn)do if b-e.SpawnTime>21 then IROVar.Lock.Imp.spawn[d]=nil;IROVar.Lock.Imp.count=IROVar.Lock.Imp.count-1 end end end;function IROVar.Lock.COMBAT_LOG_EVENT_UNFILTERED_OnEvent()local f,g,f,h,f,f,f,i,j,f,f,k,l=CombatLogGetCurrentEventInfo()if h==IROVar.Lock.playerGUID and g=="SPELL_CAST_FAILED"then IROVar.Lock.SS.trust_segment_cast=true end;if IROSpecID==266 then if h==IROVar.Lock.playerGUID then if g=="SPELL_SUMMON"then if j=="Wild Imp"then IROVar.Lock.Imp.spawn[i]={FelFireboltCount=6,SpawnTime=GetTime()+(IROVar.Lock.Imp.FreezEn and 15 or 0),ExpireTimeHandel=C_Timer.NewTimer(21,IROVar.Lock.CheckImpExpire)}IROVar.Lock.Imp.count=IROVar.Lock.Imp.count+1 end elseif g=="SPELL_CAST_SUCCESS"and k==196277 then for f,e in pairs(IROVar.Lock.Imp.spawn)do e.ExpireTimeHandel:Cancel()end;IROVar.Lock.Imp.spawn={}IROVar.Lock.Imp.count=0 elseif g=="SPELL_AURA_APPLIED"and k==265273 then IROVar.Lock.Imp.FreezEn=true;for f,e in pairs(IROVar.Lock.Imp.spawn)do e.SpawnTime=e.SpawnTime+15 end elseif g=="SPELL_AURA_REMOVED"and k==265273 then IROVar.Lock.Imp.FreezEn=false end end;if not IROVar.Lock.Imp.FreezEn and IROVar.Lock.Imp.spawn[h]and g=="SPELL_CAST_SUCCESS"and k==104318 then IROVar.Lock.Imp.spawn[h].FelFireboltCount=IROVar.Lock.Imp.spawn[h].FelFireboltCount-1;if IROVar.Lock.Imp.spawn[h].FelFireboltCount==0 then IROVar.Lock.Imp.spawn[h].ExpireTimeHandel:Cancel()IROVar.Lock.Imp.spawn[h]=nil;IROVar.Lock.Imp.count=IROVar.Lock.Imp.count-1 end end end end;function IROVar.Lock.GetWildImpCount(m)if IROVar.Lock.Imp.count==0 then return 0 end;m=m or 0;local n=IROVar.Lock.Imp.count;if m>=2 then for f,e in pairs(IROVar.Lock.Imp.spawn)do if e.FelFireboltCount<m then n=n-1 end end end;return n end;IROVar.Lock.SS.Frame=CreateFrame("Frame")IROVar.Lock.SS.Frame:RegisterEvent("COMBAT_LOG_EVENT_UNFILTERED")IROVar.Lock.SS.Frame:SetScript("OnEvent",IROVar.Lock.COMBAT_LOG_EVENT_UNFILTERED_OnEvent)IROVar.Lock.SS.trust_segment_cast=true;IROVar.Lock.SS.old_timer_check=0;IROVar.Lock.SS.old_val=0;function IROVar.Lock.PredictSS()local b=GetTime()if IROVar.Lock.SS.old_timer_check==b then return IROVar.Lock.SS.old_val end;if not IROVar.Lock.SS.trust_segment_cast then if b>IROVar.Lock.SS.old_spell_finish_cast_check then IROVar.Lock.SS.trust_segment_cast=true else return IROVar.Lock.SS.old_val end end;if not IROSpecID then IROSpecID=GetSpecializationInfo(GetSpecialization())end;local o=UnitPower("player",7,true)local l,f,f,p,q=UnitCastingInfo("player")if l then local r=q/1000;IROVar.Lock.SS.trust_segment_cast=r-b>0.3;if IROVar.Lock.SS.trust_segment_cast then if l=="Incinerate"then local s;local t;local u=false;for v=1,30 do s="nameplate"..v;if UnitExists(s)and UnitCanAttack("player",s)then t=IROVar.allDeBuffByMe(s)if t["Havoc"]then u=not UnitIsUnit("target",s)and t["Havoc"]>0.1+r-b;break end end end;if u then o=o+4 else o=o+2 end else o=o+(IROVar.Lock.SS.LockSpellModSS[l..IROSpecID]or 0)end;o=o<=50 and o or 50;o=o>=0 and o or 0;IROVar.Lock.SS.old_spell_finish_cast_check=r+0.2 else return IROVar.Lock.SS.old_val end end;IROVar.Lock.SS.old_timer_check=b;IROVar.Lock.SS.old_val=o;return o end