-- Many Function Version 9.0.5/40
if not IROVar then IROVar={}end;IROVar.DebugMode=false;IROVar.InterruptSpell=nil;IROVar.SkillCheckDPSRange=nil;IROVar.InstanceName=GetInstanceInfo()IROVar.activeConduits=nil;if not IROSpecID then IROSpecID=GetSpecializationInfo(GetSpecialization())end;IROInterruptTier={}for a,b in pairs(IROUsedSkillControl.ClassType)do IROInterruptTier[a]=b end;IROInterruptTier.CDEnd=0;function IROVar.Debug()IROVar.DebugMode=not IROVar.DebugMode;print("IROVar.DebugMode : "..(IROVar.DebugMode and"On"or"Off"))end;function IROVar:fspecOnEvent(c)if IROVar.DebugMode then print("Event : "..(c~=nil and c or"nil"))end;IROVar.UpdateVar()C_Timer.After(5,IROVar.UpdateVar)end;IROVar.fspec=CreateFrame("Frame")IROVar.fspec:RegisterEvent("PLAYER_SPECIALIZATION_CHANGED")IROVar.fspec:RegisterEvent("ZONE_CHANGED_NEW_AREA")IROVar.fspec:SetScript("OnEvent",IROVar.fspecOnEvent)function IROVar.UpdateVar()IROVar.InstanceName=GetInstanceInfo()local d=GetSpecializationInfo(GetSpecialization())if IROVar.DebugMode then if IROSpecID~=d and d~=nil then print("old Spec :"..(IROSpecID~=nil and IROSpecID or"nil"))print("new Spec :"..(d~=nil and d or"nil"))end end;IROSpecID=d or IROSpecID;if IROInterruptTier[IROSpecID]then IROVar.InterruptSpell=IROInterruptTier[IROSpecID][2]IROVar.SkillCheckDPSRange=IROInterruptTier[IROSpecID][3]else IROVar.InterruptSpell=nil;IROVar.SkillCheckDPSRange=nil end end;IROVar.UpdateVar()C_Timer.After(5,IROVar.UpdateVar)IROVar.CheckDPSRange=function(e)if IROVar.SkillCheckDPSRange==nil then return true end;e=e or"target"return IsSpellInRange(IROVar.SkillCheckDPSRange,e)==1 end;IROVar.ERO_Old_Val={Timer=0,Old_Val={},Check=function(f,g)return IROVar.ERO_Old_Val.Timer==GetTime()and IROVar.ERO_Old_Val.Old_Val[f]and IROVar.ERO_Old_Val.Old_Val[f][g]and IROVar.ERO_Old_Val.Old_Val[f][g]or nil end,Update=function(f,g,h)local i=GetTime()if IROVar.ERO_Old_Val.Timer<i then IROVar.ERO_Old_Val.Timer=i;IROVar.ERO_Old_Val.Old_Val={}end;if not IROVar.ERO_Old_Val.Old_Val[f]then IROVar.ERO_Old_Val.Old_Val[f]={}end;IROVar.ERO_Old_Val.Old_Val[f][g]=h end}local j={[2]=37727,[3]=42732,[4]=129055,[5]=8149,[7]=61323,[8]=34368,[10]=32321,[15]=33069,[20]=10645,[25]=24268,[30]=835,[35]=24269,[38]=140786,[40]=28767,[45]=23836,[50]=116139,[55]=74637,[60]=32825,[70]=41265,[80]=35278,[90]=133925,[100]=33119,[150]=46954,[200]=75208}IROVar.ItemNameToCheck8="item:34368"function IROEnemyCountInRange(k)k=k or 8;local l=IROVar.ERO_Old_Val.Check("IROEnemyCountInRange",k)if l then return l end;if k<2 then k=2 end;while j[k]==nil do k=k-1 end;local m="item:"..j[k]local n;local o=0;for p=1,30 do n='nameplate'..p;if UnitExists(n)and UnitCanAttack("player",n)then if IsItemInRange(m,n)and(UnitAffectingCombat(n)or k<=8 or IsItemInRange(IROVar.ItemNameToCheck8,n))then o=o+1 end end;if o>=8 then break end end;IROVar.ERO_Old_Val.Update("IROEnemyCountInRange",k,o)return o end;function IsMyInterruptSpellReady()if not IROVar.InterruptSpell then return false end;local q=GetTime()if IROInterruptTier.CDEnd>q then return false end;local r=TMW.CNDT.Env.CooldownDuration(IROVar.InterruptSpell)if r>0 then IROInterruptTier.CDEnd=r+q;return false end;return true end;function PercentCastbar2(s,t,u,v,w)s=s or 0.5;if t==nil then t=true end;w=w or 2000;v=v or 200;u=u or"target"local _,_,_,x,y,_,_,z=UnitCastingInfo(u)local A=false;local B;local C;local D;if x~=nil and not(z and t)then B=y-x;C=GetTime()*1000-x;if B-C>=v and B-C<=w then D=C/B;A=D>=s end;return A end;local _,_,_,E,F,_,G=UnitChannelInfo(u)if E~=nil and not(G and t)then B=F-E;C=GetTime()*1000-E;if C>=v and C<=B-v then A=true end end;return A end;function GCDActiveLessThan(H)H=H or 0.2;local I,J=GetSpellCooldown(TMW.GCDSpell)return I+J-GetTime()<H end;function SumPartyHP()local K=IROVar.ERO_Old_Val.Check("SumPartyHP","")if K then return K end;local L=0;if IsInRaid()then local M=GetNumGroupMembers()if M==0 then M=1 end;for p=1,M do L=L+UnitHealth("raid"..p)end elseif IsInGroup()then L=UnitHealth("player")local M=GetNumGroupMembers()for p=1,M-1 do L=L+UnitHealth("party"..p)end else L=UnitHealth("player")end;IROVar.ERO_Old_Val.Update("SumPartyHP","",L)return L end;function SumHPMobinCombat()local K=IROVar.ERO_Old_Val.Check("SumHPMobinCombat","")if K then return K end;local N=0;local n;for O=1,30 do n='nameplate'..O;if UnitExists(n)and UnitCanAttack("player",n)and(UnitAffectingCombat(n)or IsItemInRange(IROVar.ItemNameToCheck8,n))then N=N+UnitHealth(n)end end;IROVar.ERO_Old_Val.Update("SumHPMobinCombat","",N)return N end;function SumHPMobin8yd()local N=0;local n;for O=1,30 do n='nameplate'..O;if UnitExists(n)and CheckInteractDistance(n,2)and UnitCanAttack("player",n)then N=N+UnitHealth(n)end end;return N end;function IROTargetVVHP(P)P=P or 2;local Q=SumPartyHP()local R=UnitHealthMax("target")return P*Q<R end;function IROEnemyGroupVVHP(P)P=P or 3;local Q=SumPartyHP()local S=SumHPMobinCombat()return P*Q<S end;local T={[259]=true,[260]=true,[261]=true,[269]=true,[103]=true}function GCDCDTime()local l=IROVar.ERO_Old_Val.Check("GCDCDTime","")if l then return l end;local U=TMW.GCD;if U==0 then if not IROSpecID then IROSpecID=GetSpecializationInfo(GetSpecialization())end;if T[IROSpecID]then U=1 else U=1.5*100/(100+UnitSpellHaste("player"))end end;IROVar.ERO_Old_Val.Update("GCDCDTime","",U)return U end;IROVar.temp_allDeBuffByMe={[1]=0,[2]={}}function IROVar.allDeBuffByMe(u)local V={}local W=UnitGUID(u)if not W then return V end;local X=GetTime()if IROVar.temp_allDeBuffByMe[1]==X and IROVar.temp_allDeBuffByMe[2][W]then return IROVar.temp_allDeBuffByMe[2][W]end;if IROVar.temp_allDeBuffByMe[1]<X then IROVar.temp_allDeBuffByMe[1]=X;IROVar.temp_allDeBuffByMe[2]={}end;local Y,Z;for p=1,400 do Y,_,_,_,_,Z=UnitAura(u,p,"PLAYER|HARMFUL")if Y then V[Y]=Z-GetTime()else break end end;IROVar.temp_allDeBuffByMe[2][W]=V;return V end;IROVar.temp_allBuffByMe={[1]=0,[2]={}}function IROVar.allBuffByMe(u,a0)local a1={}local W=UnitGUID(u)if not W then return a1 end;local X=GetTime()if IROVar.temp_allBuffByMe[1]==X and IROVar.temp_allBuffByMe[2][W]then return IROVar.temp_allBuffByMe[2][W]end;if IROVar.temp_allBuffByMe[1]<X then IROVar.temp_allBuffByMe[1]=X;IROVar.temp_allBuffByMe[2]={}end;local a2,Z;if a0 then for p=1,400 do a2,_,_,_,_,Z=UnitAura(u,p,"PLAYER|HELPFUL")if a2 then a1[string.lower(a2)]=Z-GetTime()else break end end else for p=1,400 do a2,_,_,_,_,Z=UnitAura(u,p,"PLAYER|HELPFUL")if a2 then a1[a2]=Z-GetTime()else break end end end;IROVar.temp_allBuffByMe[2][W]=a1;return a1 end;IROVar.DontUseCD={["Mists of Tirna Scithe"]={["Droman Oulfarran"]=true}}function IROVar.IconSweepCompair(a3,a4,a5)if not a3 then return true end;local a6=a3.Modules.IconModule_CooldownSweep.start+a3.Modules.IconModule_CooldownSweep.duration;local a7=a6-a4;local a8=a6-a5;local a9=GetTime()return a9>a7 and a9<a8 end;function IROVar.DetermineActiveCovenantAndSoulbindAndConduits()local aa=C_Covenants.GetActiveCovenantID()if not aa or aa==0 then return nil end;local ab=C_Covenants.GetCovenantData(aa)if not ab then return nil end;local ac=ab.name;local ad=C_Soulbinds.GetActiveSoulbindID()if not ad or ad==0 then return nil end;local ae=C_Soulbinds.GetSoulbindData(ad)if not ae then return nil end;local af=ae["ID"]local ag=ae["name"]local ah=ae["description"]local ai=ae["tree"]local aj=ai["nodes"]local ak={}ak.covenantName=ac;ak.soulbindName=ag;ak.conduits={}for _,al in pairs(aj)do local am=al["ID"]local an=al.row;local ao=al.column;local ap=al.spellID;local aq=al.conduitID;local ar=al.conduitRank;local as=al.state;local at=al.conduitType;if as==3 then local au;if ap~=0 then au=GetSpellInfo(ap)elseif aq~=0 then local av=C_Soulbinds.GetConduitSpellID(aq,ar)ap=av;au=GetSpellInfo(av)else ap=nil;au=nil end;if ap then ak.conduits[#ak.conduits+1]={spellID=ap,spellName=au}ak[ap]=true;ak[au]=true end end end;return ak end;IROVar.justCheckActiveConduits=0;IROVar.fconduitOnEvent=function()local aw=GetTime()if aw<=IROVar.justCheckActiveConduits then return end;IROVar.justCheckActiveConduits=aw+0.1;IROVar.activeConduits=IROVar.DetermineActiveCovenantAndSoulbindAndConduits()end;IROVar.fconduit=CreateFrame("Frame")IROVar.fconduit:RegisterEvent("COVENANT_CALLINGS_UPDATED")IROVar.fconduit:RegisterEvent("COVENANT_CHOSEN")IROVar.fconduit:RegisterEvent("SOULBIND_ACTIVATED")IROVar.fconduit:RegisterEvent("SOULBIND_PATH_CHANGED")IROVar.fconduit:RegisterEvent("SOULBIND_NODE_UPDATED")IROVar.fconduit:RegisterEvent("GARRISON_UPDATE")IROVar.fconduit:SetScript("OnEvent",IROVar.fconduitOnEvent)C_Timer.After(1,IROVar.fconduitOnEvent)