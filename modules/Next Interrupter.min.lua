--Next Interrupter!!!! V 2.10b
--WORK Only counter interruptCounterName=1
InterruptCounterName="wantinterrupt"
TMW_ST:UpdateCounter(InterruptCounterName,1)if not NextInterrupter then NextInterrupter={}end;if not NextInterrupter.Setuped then NextInterrupter.Setuped=false;NextInterrupter.SpecID=nil;NextInterrupter.Tier=nil;NextInterrupter.SpellName=nil;NextInterrupter.Name=nil;NextInterrupter.PlayerName=nil;NextInterrupter.isWarlock=nil;NextInterrupter.isWarrior=nil;NextInterrupter.Enabled=false;NextInterrupter.ITable={}NextInterrupter.AddonMessagePrefix="IRODPSUN"NextInterrupter.canInterrupt=false;NextInterrupter.TargetGUID=''NextInterrupter.CheckSyncRecive={}NextInterrupter.interruptTier={[71]={'B','Pummel'},[72]={'B','Pummel'},[73]={'A','Pummel'},[265]={'D','Command Demon'},[266]={'D','Command Demon'},[267]={'D','Command Demon'},[262]={'C','Wind Shear'},[263]={'B','Wind Shear'},[264]={'D','Wind Shear'},[259]={'B','Kick'},[260]={'B','Kick'},[261]={'B','Kick'},[256]={'N',''},[257]={'N',''},[258]={'D','Silence'},[65]={'N',''},[66]={'A','Rebuke'},[70]={'B','Rebuke'},[268]={'A','Spear Hand Strike'},[270]={'N',''},[269]={'B','Spear Hand Strike'},[62]={'C','Counterspell'},[63]={'C','Counterspell'},[64]={'C','Counterspell'},[253]={'C','Counter Shot'},[254]={'C','Counter Shot'},[255]={'C','Muzzle'},[102]={'C','Solar Beam'},[103]={'B','Skull Bash'},[104]={'A','Skull Bash'},[105]={'N',''},[577]={'B','Disrupt'},[581]={'A','Disrupt'},[250]={'A','Mind Freeze'},[251]={'B','Mind Freeze'},[252]={'B','Mind Freeze'}}function NextInterrupter.SyncCode()local a=0;local function b(c)if not c then return 0 end;local d=0;local e=string.len(c)for f=1,e do d=d+string.byte(c,f)end;a=a+1;return e,d*a end;local g=0;local h=0;for i,j in pairs(NextInterrupter.ITable)do local k,c=b(i)g=g+k;h=h+c;for l,m in pairs(j)do local n,o=b(m)g=g+n;h=h+o end end;return g..h end;function NextInterrupter.updateSpec()NextInterrupter.SpecID=GetSpecializationInfo(GetSpecialization())if not NextInterrupter.interruptTier[NextInterrupter.SpecID]then NextInterrupter.Tier="F"NextInterrupter.SpellName=""else NextInterrupter.Tier=NextInterrupter.interruptTier[NextInterrupter.SpecID][1]NextInterrupter.SpellName=NextInterrupter.interruptTier[NextInterrupter.SpecID][2]end;NextInterrupter.PlayerName=UnitName("player")..'-'..GetRealmName()NextInterrupter.Name=NextInterrupter.Tier..'-'..NextInterrupter.PlayerName;NextInterrupter.isWarlock=NextInterrupter.SpecID>=265 and NextInterrupter.SpecID<=267;NextInterrupter.isWarrior=NextInterrupter.SpecID>=71 and NextInterrupter.SpecID<=73 end;function NextInterrupter.IsMyTurn(p)p=p or"target"local q=UnitGUID(p)return not NextInterrupter.Enabled or not NextInterrupter.ITable[q]or next(NextInterrupter.ITable[q])==nil or NextInterrupter.ITable[q][1]==NextInterrupter.Name end;function NextInterrupter.Enable()if NextInterrupter.HasDebugAddon then NextInterrupter.AddDebugTextLog("*** NextInterrupter.Enable : "..GetTime())end;NextInterrupter.Enabled=true;NextInterrupter.updateSpec()NextInterrupter.SendISM()end;function NextInterrupter.Disable()if NextInterrupter.HasDebugAddon then NextInterrupter.AddDebugTextLog("*** NextInterrupter.Disable : "..GetTime())end;NextInterrupter.Enabled=false;NextInterrupter.SendISM(false)end;function NextInterrupter.CanIInterrupt()if UnitIsDead("player")then return false end;local r=GetSpellCooldown(NextInterrupter.SpellName)==0;local p="target"local s=r and IsSpellInRange(NextInterrupter.SpellName,p)==1;if s and NextInterrupter.isWarlock then local t=GetSpellInfo(NextInterrupter.SpellName)if t~='Axe Toss'and t~='Spell Lock'then s=false end end;if s and NextInterrupter.isWarrior then local u=TMW.CNDT.Env.AuraDur("player","bladestorm","PLAYER HELPFUL")if u>0.1 then s=false end end;return s end;function NextInterrupter.CheckAndSendISM()local p="target"local v=UnitGUID(p)or"0"local s=NextInterrupter.CanIInterrupt()local w=false;if v~=NextInterrupter.TargetGUID then if NextInterrupter.canInterrupt~=s or s then w=true end else if NextInterrupter.canInterrupt~=s then w=true end end;if w then NextInterrupter.SendISM(s)end end;function NextInterrupter.SendISM(x)if NextInterrupter.HasDebugAddon then NextInterrupter.AddDebugTextLog("//SendedISM : "..GetTime())end;local p="target"local v=UnitGUID(p)or"0"local s=x or NextInterrupter.CanIInterrupt()NextInterrupter.canInterrupt=s;NextInterrupter.TargetGUID=v;local y=IsInGroup(LE_PARTY_CATEGORY_INSTANCE)and"INSTANCE_CHAT"or(IsInRaid()and"RAID"or(IsInGroup()and"PARTY"or"WHISPER"))local z=NextInterrupter.PlayerName;local A=NextInterrupter.AddonMessagePrefix;local B=(s and'CI^'or'CN^')..NextInterrupter.Name.."^"..v;if NextInterrupter.HasDebugAddon then NextInterrupter.AddDebugTextLog(">>>> "..y..' : "'..B..'"')end;C_ChatInfo.SendAddonMessage(A,B,y,z)end;function NextInterrupter.AddonMessageEvent(l,C,D,E)if C=="PLAYER_REGEN_DISABLED"and NextInterrupter.Enabled then NextInterrupter.SendISM()end;if C~="CHAT_MSG_ADDON"then return end;if D~=NextInterrupter.AddonMessagePrefix then return end;if NextInterrupter.HasDebugAddon then NextInterrupter.AddDebugTextLog("\\\\ReciveISM : "..GetTime())NextInterrupter.AddDebugTextLog('<<<< "'..E..'"')end;local F,G,H=strsplit("^",E,3)local I,J;if F=="CK"then local y="WHISPER"local z=G;local A=NextInterrupter.AddonMessagePrefix;local B="CR^"..NextInterrupter.PlayerName.."^"..NextInterrupter.SyncCode()if NextInterrupter.HasDebugAddon then NextInterrupter.AddDebugTextLog("//SendedISM : "..GetTime())NextInterrupter.AddDebugTextLog(">>>> "..y..' : "'..B..'"')end;C_ChatInfo.SendAddonMessage(A,B,y,z)return end;if F=="CR"and NextInterrupter.HasDebugAddon then NextInterrupter.CheckSyncRecive[G]=H;NextInterrupter.updateTree(true)return end;local K=false;if F=="CN"or F=="CI"then for L in pairs(NextInterrupter.ITable)do for M in pairs(NextInterrupter.ITable[L])do if NextInterrupter.ITable[L][M]==G then K=true;table.remove(NextInterrupter.ITable[L],M)if next(NextInterrupter.ITable[L])==nil then NextInterrupter.ITable[L]=nil end;break end end end end;local N=G:sub(1,1)if F=="CI"then J=false;I=0;if not NextInterrupter.ITable[H]then NextInterrupter.ITable[H]={}end;for O in pairs(NextInterrupter.ITable[H])do I=O;if N<NextInterrupter.ITable[H][O]:sub(1,1)then J=true;break end end;if not J then I=I+1 end;K=true;table.insert(NextInterrupter.ITable[H],I,G)end;if NextInterrupter.HasDebugAddon then if K then NextInterrupter.AddDebugTextLog(GetTime().." Table Change")NextInterrupter.updateTree(true)else NextInterrupter.AddDebugTextLog(GetTime().." Table Not Change")end end end;NextInterrupter.updateSpec()NextInterrupter.fspec=CreateFrame("Frame")NextInterrupter.fspec:RegisterEvent("PLAYER_SPECIALIZATION_CHANGED")NextInterrupter.fspec:SetScript("OnEvent",NextInterrupter.updateSpec)NextInterrupter.AddonMFrame=CreateFrame("Frame")NextInterrupter.AddonMFrame:RegisterEvent("CHAT_MSG_ADDON")NextInterrupter.AddonMFrame:RegisterEvent("PLAYER_REGEN_DISABLED")NextInterrupter.AddonMFrame:SetScript("OnEvent",NextInterrupter.AddonMessageEvent)C_ChatInfo.RegisterAddonMessagePrefix(NextInterrupter.AddonMessagePrefix)function NextInterrupter.CheckTarget()local P=TMW_ST:GetCounter(InterruptCounterName)if P==1 then if not NextInterrupter.Enabled then NextInterrupter.Enable()end;NextInterrupter.CheckAndSendISM()else if NextInterrupter.Enabled then NextInterrupter.Disable()end end end;NextInterrupter.fCheck=CreateFrame("Frame")NextInterrupter.fCheck:RegisterEvent("SPELL_UPDATE_COOLDOWN")NextInterrupter.fCheck:RegisterEvent("SPELL_UPDATE_USABLE")NextInterrupter.fCheck:RegisterEvent("PLAYER_TARGET_CHANGED")NextInterrupter.fCheck:SetScript("OnEvent",NextInterrupter.CheckTarget)NextInterrupter.C_TimerHandle=C_Timer.NewTicker(0.32,NextInterrupter.CheckTarget)NextInterrupter.Setuped=true end